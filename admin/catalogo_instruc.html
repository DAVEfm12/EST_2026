<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>LK Studio | Expediente Maestro de Instructores</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #D4AF37;
            --gold-bright: #FFD700;
            --rose: #E6B8A2;
            --deep-black: #050505;
            --grey-row: #161616; 
            --white-text: #FFFFFF;
            --sidebar-width: 280px;
        }

        body {
            background: var(--deep-black);
            color: var(--white-text);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width);
            background: #000;
            border-right: 2px solid var(--gold);
            height: 100vh;
            position: fixed;
            z-index: 1000;
        }

        .sidebar-logo { padding: 30px; text-align: center; border-bottom: 1px solid #222; }
        .sidebar-logo img { width: 140px; filter: drop-shadow(0 0 5px var(--gold)); }

        .nav-link {
            color: #fff !important;
            padding: 15px 25px;
            font-size: 0.85rem;
            text-transform: uppercase;
            transition: 0.3s;
            border-bottom: 1px solid #111;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .nav-link i { width: 30px; color: var(--gold-bright); }
        .nav-link:hover, .nav-link.active {
            background: rgba(212, 175, 55, 0.1);
            border-left: 5px solid var(--gold);
            color: var(--gold-bright) !important;
        }

        /* --- CONTENIDO --- */
        #content {
            width: calc(100% - var(--sidebar-width));
            margin-left: var(--sidebar-width);
            padding: 40px;
        }

        .luxury-font { font-family: 'Cinzel', serif; color: var(--gold); letter-spacing: 2px; }

        .card-form {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .section-title {
            color: var(--gold);
            font-weight: 800;
            font-size: 0.75rem;
            border-left: 3px solid var(--gold);
            padding-left: 12px;
            margin: 20px 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- TABLA GRIS CARBÓN --- */
        .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .table-custom thead th { color: var(--rose); text-transform: uppercase; letter-spacing: 1px; border: none; font-size: 0.7rem; padding: 10px; }
        .table-custom tbody tr { background: var(--grey-row) !important; transition: 0.3s; }
        .table-custom td { padding: 15px !important; color: #fff !important; border: none; vertical-align: middle; font-size: 0.85rem; }
        .table-custom tr td:first-child { border-radius: 10px 0 0 10px; border-left: 4px solid var(--gold); }
        .table-custom tr td:last-child { border-radius: 0 10px 10px 0; }

        /* INPUTS ESTILIZADOS */
        .form-label { color: var(--rose); font-size: 0.7rem; font-weight: 600; margin-bottom: 5px; }
        .form-control, .form-select {
            background: #000 !important;
            border: 1px solid #222 !important;
            color: #fff !important;
            border-radius: 8px;
            padding: 10px;
            font-size: 0.85rem;
        }
        .form-control:focus { border-color: var(--gold); box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.1); }

        .btn-gold {
            background: linear-gradient(45deg, #b38f1d, var(--gold-bright));
            color: #000; font-weight: 800; border-radius: 50px;
            border: none; padding: 12px; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 1px;
            font-size: 0.8rem;
        }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3); }

        .doc-icon { font-size: 1rem; margin-right: 5px; transition: 0.3s; cursor: pointer; }
        .doc-active { color: var(--gold-bright); }
        .doc-inactive { color: #222; }

        .badge-curso {
            background: rgba(230, 184, 162, 0.1);
            border: 1px solid var(--rose);
            color: var(--rose);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            margin: 2px;
            display: inline-block;
        }

        .scroll-form { max-height: 80vh; overflow-y: auto; padding-right: 10px; }
        .scroll-form::-webkit-scrollbar { width: 5px; }
        .scroll-form::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

        #alertaMenor { display: none; background: rgba(212, 175, 55, 0.1); border: 1px dashed var(--gold); border-radius: 10px; padding: 15px; margin-top: 15px; }
        
        .btn-gen-rfc {
            cursor: pointer;
            font-size: 0.65rem;
            color: var(--gold);
            text-decoration: none;
            transition: 0.3s;
        }
        .btn-gen-rfc:hover { color: var(--gold-bright); text-shadow: 0 0 5px var(--gold); }
    </style>
</head>

<body>

<nav id="sidebar">
    <div class="sidebar-logo">
        <img src="IMG/LKSTUDIO.png" alt="Logo">
    </div>
    <div class="mt-4">
        <a href="PANEL_ADMIN.html" class="nav-link"><i class="fas fa-chart-line"></i> Dashboard</a>
        <a href="catalogo_cursos.html" class="nav-link"><i class="fas fa-graduation-cap"></i> Cursos</a>
        <a href="#" class="nav-link active"><i class="fas fa-user-tie"></i> Instructores</a>
        <a href="catalogo_beneficios.html" class="nav-link"><i class="fas fa-gem"></i> Beneficios</a>
    </div>
</nav>

<div id="content">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="luxury-font mb-1">GESTIÓN DE EXPEDIENTES</h2>
            <p class="text-white-50 small mb-0">Control de requisitos ICATEP / SEP / Diploma de Especialidad</p>
        </div>
        <div class="text-end">
            <span class="text-rose small fw-bold">EXPEDIENTES TOTALES: </span>
            <h3 class="luxury-font mb-0" id="totalCount">0</h3>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-xl-5">
            <div class="card-form animate__animated animate__fadeInLeft">
                <form id="formInstructor" class="scroll-form">
                    
                    <div class="section-title" style="margin-top: 0;">1. Identificación Básica</div>
                    <div class="mb-3">
                        <label class="form-label">NOMBRE COMPLETO (Como aparece en acta)</label>
                        <input type="text" id="nombre" class="form-control" placeholder="Ej. Maria Lopez Perez" required oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CURP (18 caracteres)</label>
                            <input type="text" id="curp" class="form-control" placeholder="CURP" maxlength="18" oninput="this.value = this.value.toUpperCase()">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label d-flex justify-content-between">
                                RFC / ID FISCAL 
                                <span class="btn-gen-rfc" onclick="generarRFC()">
                                    <i class="fas fa-magic"></i> GENERAR DESDE CURP
                                </span>
                            </label>
                            <input type="text" id="rfc" class="form-control" placeholder="RFC" maxlength="13" oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">¿ES MENOR DE EDAD? (15-17 años)</label>
                        <select id="esMenor" class="form-select" onchange="toggleMenor()">
                            <option value="no">No, es mayor de edad</option>
                            <option value="si">Sí, es menor de edad</option>
                        </select>
                    </div>

                    <div id="alertaMenor" class="animate__animated animate__fadeIn">
                        <label class="form-label text-gold"><i class="fas fa-exclamation-triangle me-2"></i>REQUISITO ADICIONAL</label>
                        <p class="small text-white-50">Cargar INE/Pasaporte del padre, madre o tutor legal.</p>
                        <input type="file" id="file_tutor" class="form-control form-control-sm">
                    </div>

                    <div class="section-title">2. Cursos y Especialidad</div>
                    <div class="mb-3">
                        <label class="form-label">VINCULAR A CURSOS ACTIVOS</label>
                        <select id="cursosAsignados" class="form-select" multiple style="height: 80px;"></select>
                    </div>

                    <div class="section-title">3. Carga de Documentación Obligatoria</div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">INE / PASAPORTE</label>
                            <input type="file" id="file_ine" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ACTA DE NACIMIENTO</label>
                            <input type="file" id="file_acta" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CURP DIGITAL</label>
                            <input type="file" id="file_curp" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">COMPROBANTE DOMICILIO</label>
                            <input type="file" id="file_domicilio" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ÚLTIMO GRADO ESTUDIOS</label>
                            <input type="file" id="file_estudios" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">FOTO ÓVALO MIGNON</label>
                            <input type="file" id="file_foto_mignon" class="form-control form-control-sm">
                        </div>
                        <div class="col-12">
                            <label class="form-label">DIPLOMAS PREVIOS (Ambos lados)</label>
                            <input type="file" id="file_diplomas" class="form-control form-control-sm">
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-gold w-100 shadow" id="btnSubmit">
                            <i class="fas fa-save me-2"></i> FINALIZAR EXPEDIENTE DIGITAL
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-xl-7">
            <div class="table-responsive">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>INSTRUCTOR / DATOS</th>
                            <th>CURSOS</th>
                            <th class="text-center">CHECKLIST DOCS</th>
                            <th class="text-end">OPCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="tablaInstructores"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let cursosBase = JSON.parse(localStorage.getItem('LK_CURSOS_DATA')) || [];
let instructores = JSON.parse(localStorage.getItem("lk_expedientes_v3")) || [];

// Función para generar RFC desde CURP
function generarRFC() {
    const curp = document.getElementById("curp").value.trim();
    const rfcInput = document.getElementById("rfc");

    if (curp.length >= 10) {
        // Los primeros 10 del RFC son los primeros 10 del CURP
        const raiz = curp.substring(0, 10);
        // La homoclave son los últimos 3 caracteres del CURP (posiciones 15, 16, 17)
        // O una genérica si el CURP está incompleto
        const homoclave = (curp.length >= 17) ? curp.substring(15, 18) : "XX1";
        
        rfcInput.value = (raiz + homoclave).toUpperCase();
        
        // Animación de éxito en el input
        rfcInput.style.borderColor = "var(--gold-bright)";
        setTimeout(() => rfcInput.style.borderColor = "#222", 1000);
    } else {
        alert("Por favor, ingresa al menos los primeros 10 caracteres del CURP para generar el RFC.");
    }
}

const toBase64 = file => new Promise((resolve, reject) => {
    if(!file) resolve(null);
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

function toggleMenor() {
    const esMenor = document.getElementById("esMenor").value;
    document.getElementById("alertaMenor").style.display = (esMenor === "si") ? "block" : "none";
}

function cargarCursos() {
    const select = document.getElementById("cursosAsignados");
    select.innerHTML = cursosBase.map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join('');
}

function renderTable() {
    const tbody = document.getElementById("tablaInstructores");
    document.getElementById("totalCount").innerText = instructores.length;
    tbody.innerHTML = "";

    instructores.forEach((inst, idx) => {
        let cursosBadges = inst.cursos.map(c => `<span class="badge-curso">${c}</span>`).join('');
        
        tbody.innerHTML += `
            <tr class="animate__animated animate__fadeIn">
                <td>
                    <div class="fw-bold text-white" style="font-size:0.95rem">${inst.nombre}</div>
                    <div class="text-rose small" style="font-size:0.7rem">RFC: ${inst.rfc} | CURP: ${inst.curp}</div>
                </td>
                <td><div style="max-width:200px">${cursosBadges || '<span class="text-muted small">Sin cursos</span>'}</div></td>
                <td class="text-center">
                    <i class="fas fa-id-card doc-icon ${inst.docs.ine ? 'doc-active' : 'doc-inactive'}" onclick="verDoc('${inst.docs.ine}')" title="INE"></i>
                    <i class="fas fa-baby doc-icon ${inst.docs.acta ? 'doc-active' : 'doc-inactive'}" onclick="verDoc('${inst.docs.acta}')" title="Acta"></i>
                    <i class="fas fa-fingerprint doc-icon ${inst.docs.curp ? 'doc-active' : 'doc-inactive'}" onclick="verDoc('${inst.docs.curp}')" title="CURP"></i>
                    <i class="fas fa-home doc-icon ${inst.docs.domicilio ? 'doc-active' : 'doc-inactive'}" onclick="verDoc('${inst.docs.domicilio}')" title="Domicilio"></i>
                    <i class="fas fa-graduation-cap doc-icon ${inst.docs.estudios ? 'doc-active' : 'doc-inactive'}" onclick="verDoc('${inst.docs.estudios}')" title="Estudios"></i>
                    ${inst.menor === 'si' ? `<i class="fas fa-user-shield doc-icon ${inst.docs.tutor ? 'doc-active' : 'doc-inactive'}" onclick="verDoc('${inst.docs.tutor}')" title="Tutor"></i>` : ''}
                </td>
                <td class="text-end">
                    <button class="btn btn-link text-danger p-0" onclick="eliminar(${idx})"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>
        `;
    });
}

document.getElementById("formInstructor").onsubmit = async function(e) {
    e.preventDefault();
    const btn = document.getElementById("btnSubmit");
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> PROCESANDO...';
    btn.disabled = true;

    // Si el RFC está vacío al enviar, generarlo automáticamente si hay CURP
    if(!document.getElementById("rfc").value && document.getElementById("curp").value) {
        generarRFC();
    }

    const selCursos = Array.from(document.getElementById("cursosAsignados").selectedOptions).map(o => o.value);

    const instructor = {
        nombre: document.getElementById("nombre").value.toUpperCase(),
        curp: document.getElementById("curp").value.toUpperCase(),
        rfc: document.getElementById("rfc").value.toUpperCase(),
        menor: document.getElementById("esMenor").value,
        cursos: selCursos,
        docs: {
            ine: await toBase64(document.getElementById("file_ine").files[0]),
            acta: await toBase64(document.getElementById("file_acta").files[0]),
            curp: await toBase64(document.getElementById("file_curp").files[0]),
            domicilio: await toBase64(document.getElementById("file_domicilio").files[0]),
            estudios: await toBase64(document.getElementById("file_estudios").files[0]),
            mignon: await toBase64(document.getElementById("file_foto_mignon").files[0]),
            diplomas: await toBase64(document.getElementById("file_diplomas").files[0]),
            tutor: await toBase64(document.getElementById("file_tutor").files[0])
        }
    };

    instructores.push(instructor);
    localStorage.setItem("lk_expedientes_v3", JSON.stringify(instructores));
    
    this.reset();
    toggleMenor();
    btn.innerHTML = '<i class="fas fa-save me-2"></i> FINALIZAR EXPEDIENTE DIGITAL';
    btn.disabled = false;
    renderTable();
};

function verDoc(b64) {
    if(!b64 || b64 === "null") return;
    const win = window.open();
    win.document.write(`<iframe src="${b64}" frameborder="0" style="width:100%; height:100%;" allowfullscreen></iframe>`);
}

function eliminar(i) {
    if(confirm("¿Seguro que desea eliminar este expediente?")) {
        instructores.splice(i, 1);
        localStorage.setItem("lk_expedientes_v3", JSON.stringify(instructores));
        renderTable();
    }
}

cargarCursos();
renderTable();
</script>

</body>
</html>
